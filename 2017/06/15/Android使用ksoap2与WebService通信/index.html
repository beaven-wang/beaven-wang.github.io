<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android使用ksoap2与WebService通信 · Beaven's Blog</title><meta name="description" content="Android使用ksoap2与WebService通信 - Beaven Wang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicona.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Beaven's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/beaven-wang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android使用ksoap2与WebService通信</h1><div class="post-info">Jun 15, 2017</div><div class="post-content"><h4 id="一、WebService和SOAP介绍"><a href="#一、WebService和SOAP介绍" class="headerlink" title="一、WebService和SOAP介绍"></a>一、WebService和SOAP介绍</h4><p>​    WebService是一种基于SOAP协议的远程调用标准，是跨平台的，可以在不同语言中使用的。WebServie使用XML用来编解码数据，并使用SOAP来传输数据。</p>
<p>​    SOAP是基于XML的简易协议，使用XML进行编码，使用HTTP进行数据的交互，它是一种用于网络服务的协议，独立于平台，独立于语言。在Android  SDK中没有提供与WebService通信的库，所以我们需要使用第三方类库（KSOAP2）建立SOAP客户端与WebService通信。<br><a id="more"></a></p>
<h4 id="二、KSOAP2的使用"><a href="#二、KSOAP2的使用" class="headerlink" title="二、KSOAP2的使用"></a>二、KSOAP2的使用</h4><ol>
<li><a href="http://simpligility.github.io/ksoap2-android/index.html" target="_blank" rel="external">ksoap2官网</a>        <a href="https://github.com/simpligility/ksoap2-android" target="_blank" rel="external">ksoap2源码</a>        <a href="http://www.runoob.com/webservices/webservices-tutorial.html" target="_blank" rel="external">WebService教程</a>         <a href="http://www.runoob.com/soap/soap-tutorial.html" target="_blank" rel="external">SOAP教程</a></li>
<li>ksoap2步骤</li>
</ol>
<ul>
<li>使用WebService的命名空间和调用的方法名构成SoapObject:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SoapObject request = <span class="keyword">new</span> Soapobject(nameSpace,method);</div></pre></td></tr></table></figure>
<ul>
<li>设置调用方法的参数（可选）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request.addProperty(<span class="string">"param"</span>,<span class="string">"value"</span>);</div></pre></td></tr></table></figure>
<ul>
<li>构建SOAP请求体：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SoapSerializationEnvelope envelope = <span class="keyword">new</span> SoapSerializationEnvelope(SoapEnvelope.VER11);</div><div class="line">envelope.bodyOut = request();<span class="comment">//SoapObject对象</span></div><div class="line">envelope.dotNet = <span class="keyword">true</span>;<span class="comment">//是否是.NET WebService</span></div></pre></td></tr></table></figure>
<p>​    SoapEnvelope.VER11为SOAP协议的版本号，该版本号根据服务端WebService的版本号设置，现在有VER10，VER11，VER12。</p>
<ul>
<li>创建HttpTransportSE对象并调用。通过HttpTransportSE类的构造方法可以指定WebService的URL：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HttpTransportSE transport = <span class="keyword">new</span> HttpTransportSE(request.getURL(), out_times);</div><div class="line">transport.call(request.getSoapAction(), envelope); <span class="comment">//call方法调用WebService</span></div></pre></td></tr></table></figure>
<ul>
<li>得到返回值：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SoapObject soapObject = (SoapObject) envelope.getResponse();</div></pre></td></tr></table></figure>
<p>下面是简单封装的ksoap调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoapSend</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">SoapResponse</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SoapRequest soapRequest;</div><div class="line">   </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoapSend</span><span class="params">(SoapRequest soapRequest)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.soapRequest = soapRequest;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SoapResponse <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        Object result = sendSoap(soapRequest);</div><div class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span> &amp;&amp; result <span class="keyword">instanceof</span> SoapObject) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SoapResponse(result);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">sendSoap</span><span class="params">(SoapRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SoapSerializationEnvelope envelope = <span class="keyword">new</span> SoapSerializationEnvelope(SoapEnvelope.VER11);</div><div class="line">            envelope.bodyOut = request.getParameters();</div><div class="line">            envelope.dotNet = <span class="keyword">true</span>;</div><div class="line">            envelope.setOutputSoapObject(request.getParameters());</div><div class="line">            <span class="keyword">new</span> MarshalBase64().register(envelope);</div><div class="line">            <span class="keyword">int</span> out_times = <span class="number">20000</span>;</div><div class="line">            HttpTransportSE transport = <span class="keyword">new</span> HttpTransportSE(request.getURL(), out_times);</div><div class="line">            transport.call(request.getSoapAction(), envelope);</div><div class="line">            <span class="keyword">return</span> envelope.getResponse();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException | XmlPullParserException e) &#123;</div><div class="line">            soapRequest.onNetError(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SoapRequest</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String URL;</div><div class="line">    <span class="keyword">private</span> String nameSpace;</div><div class="line">    <span class="keyword">private</span> String methodName;</div><div class="line">    <span class="keyword">private</span> String soapAction;</div><div class="line">    <span class="keyword">private</span> SoapObject parameters;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onNetError</span><span class="params">(Exception e)</span></span>;</div><div class="line">    <span class="keyword">private</span> ExecutorService executorService = Executors.newCachedThreadPool();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">SoapRequest</span><span class="params">(String URL, String nameSpace, String methodName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.URL = URL;</div><div class="line">        <span class="keyword">this</span>.nameSpace = nameSpace;</div><div class="line">        <span class="keyword">this</span>.methodName = methodName;</div><div class="line">        <span class="keyword">this</span>.soapAction = nameSpace + methodName;</div><div class="line"></div><div class="line">        parameters = <span class="keyword">new</span> SoapObject(nameSpace, methodName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addParameter</span><span class="params">(String name, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        addParameter(name, String.valueOf(value));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addParameter</span><span class="params">(String name, <span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">        addParameter(name, String.valueOf(value));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addParameter</span><span class="params">(String name, String value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        parameters.addProperty(name, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> SoapObject <span class="title">getParameters</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> parameters;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSoapAction</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> soapAction;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getURL</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> URL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> SoapResponse <span class="title">sendRequest</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            FutureTask&lt;SoapResponse&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> SoapSend(<span class="keyword">this</span>));</div><div class="line">            executorService.submit(futureTask);</div><div class="line">            <span class="keyword">return</span> futureTask.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">      </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/19/Android使用Retrofit进行SOAP通信/" class="prev">上一篇</a><a href="/2017/05/21/Java阻塞队列的使用/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Beaven Wang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>
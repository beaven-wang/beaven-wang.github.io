<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Java阻塞队列的使用 · Beaven's Blog</title><meta name="description" content="Java阻塞队列的使用 - Beaven Wang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicona.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Beaven's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/beaven-wang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Java阻塞队列的使用</h1><div class="post-info">May 21, 2017</div><div class="post-content"><p>Java中的阻塞队列的学习使用。<br><a id="more"></a></p>
<p>一、阻塞队列介绍(BlockingQueue)</p>
<p>1.BlockingQueue是一种支持两个附加操作的队列，这两个操作是：</p>
<p>(1)获取元素的操作会在队列为空时进行等待，直至队列为非空时继续；<br>(2)存储元素的操作会在队列满时进行等待，直至队列出现可用空间时继续。</p>
<p>2.BlockingQueue的方法以四种形式出现：</p>
<p> BlockingQueue不能够存入null元素，会抛出NullPointerException异常，null 被用作指示 poll 操作失败的警戒值。</p>
<p><img src="http://img.blog.csdn.net/20161018215313866" alt=""></p>
<p>3.BlockingQueue主要用于实现生产者-消费者模式，生产者线程向队列容器中添加元素，消费者线程从队列中取出元素。BlockingQueue实现是线程安全的，所有排队方法都可以使用内部锁或其他形式的并发控制来自动达到它们的目的。</p>
<p>二、BlockingQueue的常见实现类</p>
<p>1.ArrayBlockingQueue一个由数组结构组成的有界阻塞队列，遵循“先进先出”原则对元素进行排序。队列空间的大小固定，一旦创建以后就不可以再增加容量。试图向 已满队列中放入元素会导致操作受阻塞；试图从空队列中提取元素将导致类似阻塞。</p>
<p>默认情况下不保证对访问者的公平访问队列，即先阻塞的线程先访问。但是可以通过构造方法中设置fairness（公平性）属性为true，创建公平的访问队列。公平性会对性能产生影响，但也减少了可变性和不平衡性。</p>
<p>​    ArrayBlockingQueue mArrayBlockingQueue = new ArrayBlockingQueue(10,true);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayBlockingQueue&lt;String&gt; mArrayBlockingQueue = <span class="keyword">new</span> ArrayBlockingQueue(<span class="number">10</span>,<span class="keyword">true</span>);</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer()).start();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer()).start();</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    mArrayBlockingQueue.put(<span class="string">"数据:"</span>+i);</div><div class="line">                    <span class="comment">//若队列空间已满，会进入阻塞状态</span></div><div class="line">                    Thread.sleep(<span class="number">20000</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    System.out.println(mArrayBlockingQueue.take());</div><div class="line">                    <span class="comment">//当队列为空时，会进入阻塞状态</span></div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>2.LinkedBlockingQueue</p>
<p>一个基于链表的阻塞队列，其实现的队列可以不指定队列大小，默认是Integer.MAX_VALUE。<br>其实现队列中的锁是分离的，生产者和消费者可以并行的操作队列中的数据，从而使得并发执行数据的效率更高。实现方式和ArrayBlockingQueue 基本一致。</p>
<p>3.PriorityBlockingQueue</p>
<p>一种优先级队列，队列中的元素按照优先级排列。队列中存储的对象必须实现Comparable接口，确定对象的优先级。<br>其比较规则：<br>（1）当前对象和其他对象比较，如果如果compare方法返回-1，那么其优先级高于比较的对象。<br>（2）compare方法返回0，则两个优先级相等。<br>（3）compare方法返回1，则优先级低于比较的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandPriority</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">CommandPriority</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> Command command;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> priority;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandPriority</span><span class="params">(Command command, <span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.command = command;</div><div class="line">        <span class="keyword">this</span>.priority = priority;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Command <span class="title">getCommand</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> command;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"CommandPriority&#123;"</span> +</div><div class="line">                <span class="string">"command="</span> + command +</div><div class="line">                <span class="string">", priority="</span> + priority +</div><div class="line">                <span class="string">'&#125;'</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(@NonNull CommandPriority o)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.priority &gt; o.priority) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.priority &lt; o.priority) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 4.SynchronousQueue</p>
<p>一个没有数据缓冲的队列，生产者对其的插入操作put后进入阻塞状态直至消费者执行take操作后才执行下一次操作，反之亦然；它的内部由于没有数据缓存空间，所以不能使用peek来查看队列中是否存在元素，其返回值永远为null。</p>
<p>5.DelayQueue</p>
<p>一个无界的阻塞队列，队列中的元素需要实现Delayed接口，Delayed接口继承Comparable接口，其元素存入队列时需要进行比较，比较的基准为延时的时间值，它是一种内部由PriorityQueue实现的变体。队列中的元素在到期时才能从队列中取出，对头的元素是最紧急任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JAVA编程思想中的例子</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Delayed</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> current = <span class="number">0</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id = current++;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> detail;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> trigger;</div><div class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> List&lt;DelayedTask&gt; sequence = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DelayedTask</span><span class="params">(<span class="keyword">int</span> delayedInMillisecond)</span> </span>&#123;</div><div class="line">            detail = delayedInMillisecond;</div><div class="line">            trigger = System.nanoTime() + NANOSECONDS.convert(detail, MILLISECONDS);</div><div class="line">            sequence.add(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="keyword">this</span> + <span class="string">"aa"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</div><div class="line">            <span class="comment">//获取剩余延长时间</span></div><div class="line">            <span class="keyword">return</span> unit.convert(trigger - System.nanoTime(), NANOSECONDS);</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</div><div class="line">            <span class="comment">//进行比较</span></div><div class="line">            DelayedTask that = (DelayedTask) o;</div><div class="line">            <span class="keyword">if</span> (trigger &lt; that.trigger) <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (trigger &gt; that.trigger) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/15/Android使用ksoap2与WebService通信/" class="prev">上一篇</a><a href="/2017/04/22/Android中LruCache实现分析/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Beaven Wang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>
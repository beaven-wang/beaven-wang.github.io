<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android中LruCache实现分析 · Beaven's Blog</title><meta name="description" content="Android中LruCache实现分析 - Beaven Wang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicona.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Beaven's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/beaven-wang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android中LruCache实现分析</h1><div class="post-info">Apr 22, 2017</div><div class="post-content"><p>在手机应用开发中，为了保存数据访问的流畅性和降低网络流量的消耗，缓存是我们经常需要使用到的。而缓存的实现有多种方式，如LFU（最少的使用）、LRU（最不经常的使用）等。LRU算法是我们开发中经常使用的一种方式，本篇主要分许Android官方提供的LruCache的实现方式 。<br><a id="more"></a></p>
<h4 id="Lru介绍"><a href="#Lru介绍" class="headerlink" title="Lru介绍"></a>Lru介绍</h4><ul>
<li>Lru是一种常见的缓存算法，其实现原理是当缓存数据量超过规定的范围时，就把最早存入的数据删除，确保缓存数量在规定的范围内。</li>
<li>在Java语言中Lru缓存算法的实现一般有两种，一种是使用LinkedHashMap实现，一种是自己设计使用链表+HashMap实现。</li>
</ul>
<h4 id="Androiod中LruChche的实现"><a href="#Androiod中LruChche的实现" class="headerlink" title="Androiod中LruChche的实现"></a>Androiod中LruChche的实现</h4><p>在Android中已经对LruCache添加了实现类，可以方便的实现Lru缓存。这里就不介绍关于LruCahe的使用，主要是对Android官方的LruCache实现的分析。</p>
<ol>
<li>Android官方提供的LruCache的底层实现是基于LinkedHashMap来实现的。LinkedHashMap是继承自HashMap类，所以都是存储键值对的结构，同时LinkedHashMap加入了双向循环链表，可以保存节点的插入顺序，这提供了Lru实现的基础。</li>
<li><p>LruCache的构造，LruCache只提供了一个传入容量值的的构造函数，函数中初始化LinkedHashMap指定元素按照访问顺序排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//构造函数中传入缓存容量值</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxSize &lt;= 0"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">this</span>.maxSize = maxSize;</div><div class="line">       <span class="keyword">this</span>.map = <span class="keyword">new</span> LinkedHashMap&lt;K, V&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);<span class="comment">//指定按照访问顺序排序</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>LruCache的put操作，调用map的put方法存入数据，同时执行缓存清理方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">   	<span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</div><div class="line">     		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null || value == null"</span>);</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	V previous;</div><div class="line">   	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; <span class="comment">//同步操作</span></div><div class="line">     	 putCount++;</div><div class="line">     	 size += safeSizeOf(key, value);<span class="comment">//记录当前存储的数据数量</span></div><div class="line">     	 previous = map.put(key, value);<span class="comment">//执行map的put操作获取</span></div><div class="line">     	 <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">      	  size -= safeSizeOf(key, value);</div><div class="line">     	 &#125;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	<span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">     	  entryRemoved(<span class="keyword">false</span>, key, previous, value);</div><div class="line">   	&#125;</div><div class="line">   	trimToSize(maxSize);<span class="comment">//清理超出容器的数据项</span></div><div class="line">   	<span class="keyword">return</span> previous;</div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>LruCache的get操作，根据key取值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</div><div class="line">   	<span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">     		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null"</span>);</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">       * 执行map.get()方法，如果获取到值直接返回。</div><div class="line">       * /</div><div class="line">   	V mapValue;</div><div class="line">   	synchronized (this) &#123;</div><div class="line">     		mapValue = map.get(key);</div><div class="line">     		if (mapValue != null) &#123;</div><div class="line">       		hitCount++;</div><div class="line">       		return mapValue;</div><div class="line">     		&#125;</div><div class="line">     	missCount++;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	/**</div><div class="line">    	* 在没有获取到值时，会尝试创建一个值，但可能需要较长的时间，而且当创建完成后map可能发生变化。</div><div class="line">    	* 如果当create()正在执行时，一个冲突的值添加进map，我们将该值留在map中并释放所创建的值。</div><div class="line">    	*/</div><div class="line">   	V createdValue = create(key);<span class="comment">//创建操作</span></div><div class="line">   	<span class="keyword">if</span> (createdValue == <span class="keyword">null</span>) &#123;</div><div class="line">     		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">     		createCount++;</div><div class="line">     		mapValue = map.put(key, createdValue);</div><div class="line"></div><div class="line">     		<span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">       		<span class="comment">//冲突，不做最后的put</span></div><div class="line">       		map.put(key, mapValue);</div><div class="line">     		&#125; <span class="keyword">else</span> &#123;</div><div class="line">       		size += safeSizeOf(key, createdValue);</div><div class="line">     		&#125;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	<span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">     		entryRemoved(<span class="keyword">false</span>, key, createdValue, mapValue);</div><div class="line">     		<span class="keyword">return</span> mapValue;</div><div class="line">   	&#125; <span class="keyword">else</span> &#123;</div><div class="line">     		trimToSize(maxSize); <span class="comment">//如果创建了新的值，同样执行缓存清理方法。</span></div><div class="line">     		<span class="keyword">return</span> createdValue;</div><div class="line">   	&#125;</div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>remove操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   *根据key移除数据项</div><div class="line">   *<span class="doctag">@return</span> 通过key得到的先前的value值</div><div class="line">   */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">remove</span><span class="params">(K key)</span> </span>&#123;</div><div class="line">   	<span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">     		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null"</span>);</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	V previous;</div><div class="line">   	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">     		previous = map.remove(key);<span class="comment">//remove操作</span></div><div class="line">     		<span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">       		size -= safeSizeOf(key, previous);</div><div class="line">     		&#125;</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">   	<span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">     		entryRemoved(<span class="keyword">false</span>, key, previous, <span class="keyword">null</span>);</div><div class="line">   	&#125;</div><div class="line">   	<span class="keyword">return</span> previous;</div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>缓存清理方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">   	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;<span class="comment">//循环操作</span></div><div class="line">     	 K key;</div><div class="line">     	 V value;</div><div class="line">     	 <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">       	<span class="keyword">if</span> (size &lt; <span class="number">0</span> || (map.isEmpty() &amp;&amp; size != <span class="number">0</span>)) &#123;</div><div class="line">         		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(getClass().getName()</div><div class="line">             	+ <span class="string">".sizeOf() is reporting inconsistent results!"</span>);</div><div class="line">       	&#125;</div><div class="line">       	<span class="keyword">if</span> (size &lt;= maxSize || map.isEmpty()) &#123;</div><div class="line">         		<span class="keyword">break</span>;<span class="comment">//在当前存储数据项小于规定容量或者map为空时，停止循环。</span></div><div class="line">       	&#125;</div><div class="line">           <span class="comment">//删除元素</span></div><div class="line">       	Map.Entry&lt;K, V&gt; toEvict = map.entrySet().iterator().next();</div><div class="line">       	key = toEvict.getKey();</div><div class="line">       	value = toEvict.getValue();</div><div class="line">       	map.remove(key);</div><div class="line">       	size -= safeSizeOf(key, value);</div><div class="line">       	evictionCount++;</div><div class="line">     	 &#125;</div><div class="line">     	 entryRemoved(<span class="keyword">true</span>, key, value, <span class="keyword">null</span>);</div><div class="line">   	&#125;</div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>Android官方提供在android.util包中的LruCache的实现非常简单，其在底层建立LinkedHashMap，并通过制定accessOrder为true，即按照访问顺序来排序。这样进行put和get操作时将会把最近操作的数据项Entry放入双向链表的后面，从而保证了在清除超出规定范围的数据项时，删除的最前面的的就是当前最少使用的数据项。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/21/Java阻塞队列的使用/" class="prev">上一篇</a><a href="/2017/04/10/WebView重定向返回问题解决/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Beaven Wang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>